# _*_ codign:utf8 _*_
"""====================================
@Author:Sadam·Sadik
@Email：1903249375@qq.com
@Date：2022/7/28
@Software: PyCharm
@disc:
======================================="""
import datetime
import os
import time

import requests


def record(ip: str, port: int = 80, requestInterval: int = 5):
    """
    :param ip:目标IP地址
    :param port:目标端口
    :param requestInterval:请求间隔，采用秒
    """
    target = f"{ip}:{port}"
    print(f"开始监视目标：{target} .....")
    while True:
        resp = requests.get(f"http://{target}/onvif-http/snapshot?auth=YWRtaW46MTEK", timeout=5 * 60)
        if resp.status_code == 200:
            targetsDir = os.path.join(".", "targets")
            targetDir = os.path.join(targetsDir, f"{ip}-{port}")
            snapshotsDir = os.path.join(targetDir, "snapshots")
            if not os.path.exists(snapshotsDir):
                os.makedirs(snapshotsDir)
            imagePath = os.path.join(snapshotsDir, f"{datetime.datetime.now()}.jpeg")
            with open(imagePath, mode="wb") as f:
                f.write(resp.content)
                print(imagePath)
            time.sleep(requestInterval)
        else:
            raise Exception("获取影响失败")
